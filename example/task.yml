platform: linux

caches:
  - path: cache

params:
  DEBUG: true
  MAX_CACHE_SIZE_MB: 4096
  ENABLE_CACHE: true

run:
  path: bash
  args:
    - -ec
    - |
      assert_contains() {
        local needle="$1"
        local input

        input="$(cat)"

        if [[ "$input" != *"$needle"* ]]; then
          echo "Expected '$needle' to be in '$input'"
          exit 1
        fi
      }

      assert_not_contains() {
        local needle="$1"
        local input

        input="$(cat)"

        if [[ "$input" == *"$needle"* ]]; then
          echo "Expected '$needle' to not be in '$input'"
          exit 1
        fi
      }
      
      ls -lah cache
      
      ls -lah /var/runtimes/docker
      echo $PATH | assert_contains "/var/runtimes/nvm/versions/node/v"
      echo $PATH | assert_contains "/var/runtimes/sdkman/candidates/java/current/bin"
      
      java --version | assert_contains "openjdk 21"
      java --version | assert_contains "OpenJDK Runtime Environment Temurin-21"

      sdk use java 25-graalce
      java --version | assert_contains "openjdk 25"
      java --version | assert_contains "OpenJDK Runtime Environment GraalVM CE 25"
      
      native-image --help | assert_contains "This tool can ahead-of-time compile Java code to native executables."
      
      yarn --version | assert_contains "4.10.2"
      pnpm --version | assert_contains "10.17.1"
      npm --version | assert_contains "11"
      
      docker --version | assert_contains "Docker version 29"
      
      echo "FROM alpine" > Dockerfile
      docker build -t runtime-test .
      
      docker run -d --name nginx-server -p 8080:80 docker.io/nginx
      sleep 5
      docker stop nginx-server
      
      docker run -d --name nginx-server-old -p 8080:80 docker.io/nginx:1.28.0
      sleep 5
      docker stop nginx-server
      
      # Do the hooks work?
      gomplate --version | assert_contains "gomplate version 4.3.3"
      curl --help | assert_contains "Usage: curl [options...]"
      wget --help | assert_contains "Usage: wget [OPTION]"
      git --version | assert_contains "git version 2"
      
      # Test rc files
      echo "v25.2.1" > .nvmrc
      echo "java=21.0.4-tem" > .sdkmanrc

      nvm install
      sdk env install

      node --version | assert_contains "25.2.1"

      # The source ~/.bashrc is rerequired to set the new candidate in the path variable.
      source ~/.bashrc
      java --version | assert_contains "openjdk 21"

      mvn --version | assert_contains "Apache Maven 3.9.6"
      gradle --version | assert_contains "Gradle 8.5"

      echo "3.12.2" > .python-version
      pyenv install --skip-existing
      pyenv local
      python --version | assert_contains "Python 3.12.2"
      go version | assert_contains "go version go1.22.1"
      
      # Check gradle.properties persistence
      cat /root/.gradle/gradle.properties | assert_contains "org.gradle.caching=true"

      # Verify that bash -c doesn't start saving the cache (verify unset BASH_ENV)
      bash -c "echo hi" | assert_not_contains "Saving"
      
      # Verify that nvm works in bash -c
      bash -c "nvm --version" | assert_contains "0.40.3"
