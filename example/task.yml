platform: linux

caches:
  - path: /cache

run:
  path: bash
  args:
    - -ec
    - |
      assert_contains() {
        local needle="$1"
        local input

        input="$(cat)"

        if [[ "$input" != *"$needle"* ]]; then
          echo "Expected '$needle' to be in '$input'"
          exit 1
        fi
      }
      
      ls -lah /var/runtimes/docker
      echo $BASH_ENV | assert_contains "/root/.bashrc"
      echo $ENV | assert_contains "/root/.bashrc"
      echo $PATH | assert_contains "/var/runtimes/nvm/versions/node/v"
      echo $PATH | assert_contains "/var/runtimes/sdkman/candidates/java/current/bin"
      
      java --version | assert_contains "openjdk 21"
      java --version | assert_contains "OpenJDK Runtime Environment Temurin-21"

      sdk use java 25-graalce
      java --version | assert_contains "openjdk 25"
      java --version | assert_contains "OpenJDK Runtime Environment GraalVM CE 25"
      
      native-image --help | assert_contains "This tool can ahead-of-time compile Java code to native executables."
      
      yarn --version | assert_contains "4.10.2"
      pnpm --version | assert_contains "10.17.1"
      npm --version | assert_contains "11"
      
      docker --version | assert_contains "Docker version 29"
      
      #echo "FROM alpine" > Dockerfile
      #docker build -t runtime-test .
      #
      #docker run -d --name nginx-server -p 8080:80 docker.io/nginx
      #sleep 5
      #docker stop nginx-server
      #
      #docker run -d --name nginx-server-old -p 8080:80 docker.io/nginx:1.28.0
      #sleep 5
      #docker stop nginx-server
      
      # Do the hooks work?
      gomplate --version | assert_contains "gomplate version 4.3.3"
      curl --help | assert_contains "Usage: curl [options...]"
      wget --help | assert_contains "Usage: wget [OPTION]"
      git --version | assert_contains "git version 2"
      
      # Test rc files
      echo "v25.2.1" > .nvmrc
      echo "java=21.0.4-tem" > .sdkmanrc

      nvm install
      sdk env install

      node --version | assert_contains "25.2.1"

      # The source ~/.bashrc is rerequired to set the new candidate in the path variable.
      source ~/.bashrc
      java --version | assert_contains "openjdk 21"
