resource_types:
- name: setup-runtime-resource
  type: registry-image
  # https://github.com/concourse/concourse/pull/9017
  privileged: true
  source:
    repository: registry:5000/setup-runtime-resource
    tag: latest
    insecure: true

resources:
- name: setup-runtime
  type: setup-runtime-resource
  icon: account-hard-hat
  source:
    hook: |
      curl -fSL https://github.com/hairyhenderson/gomplate/releases/download/v4.3.3/gomplate_linux-arm64 -o /usr/local/bin/gomplate
      chmod +x /usr/local/bin/gomplate
    dependencies:
      - wget
      - git
    java:
      version: 21
      extra_versions:
        - 25-graalce
    nodejs:
      version: lts
      yarn:
        version: 4.10.2
      pnpm:
        version: 10.17.1
    python:
      version: 3.11
    gradle:
      version: 9.0.0
    maven:
      version: 3.9.9
    testcontainers:
      enabled: true
    telemetry:
      disable: true
    verbose: true

jobs:
- name: test-setup-runtime
  plan:
  - get: setup-runtime

  - task: test-image
    image: setup-runtime
    privileged: true
    config:
      platform: linux
      inputs:
        - name: setup-runtime
      caches:
        - path: /cache
      run:
        path: bash
        args:
          - -ec
          - |
            echo $BASH_ENV
            echo $ENV
            echo $PATH

            java --version
            sdk use java 25-graalce
            echo "JAVA: $(java --version)"

            native-image --help

            echo "PYTHON: $(python --version)"
            echo "NODE: $(node --version)"
            echo "YARN: $(yarn --version)"
            echo "PNPM: $(pnpm --version)"
            echo "NPM: $(npm --version)"
            
            podman --version
            
            # Do the hooks work?
            gomplate --version
