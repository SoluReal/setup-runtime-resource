resource_types:
  - name: setup-runtime-resource
    type: registry-image
    # Running with privileged is not required and is not recommended for production use.
    privileged: true
    source:
      repository: registry:5000/setup-runtime-resource
      tag: ((setup-runtime-resource-tag))
      insecure: true
  - name: mock-via-params
    type: mock
    source:
      initial_version: some-version
    params: { mirror_self_via_params: true }

resources:
  - name: some-resource
    type: mock-via-params
    source:
      initial_version: some-version

  - name: setup-runtime
    type: setup-runtime-resource
    icon: account-hard-hat
    source:
      nvm:
        enabled: true
      verbose: true

jobs:
  - name: test-setup-runtime
    serial: true
    plan:
      - in_parallel:
          - get: setup-runtime
          - get: some-resource
      - task: test-image
        privileged: true
        image: setup-runtime
        params:
          DEBUG: true
          MAX_CACHE_SIZE_MB: 1024
        config:
          platform: linux
          caches:
            - path: cache
          inputs:
            - name: setup-runtime
            - name: some-resource
          run:
            path: bash
            args:
              - -ec
              - |
                assert_not_contains() {
                  local needle="$1"
                  local input
                  
                  input="$(cat)"
                  
                  if [[ "$input" == *"$needle"* ]]; then
                  echo "Expected '$needle' to not be in '$input'"
                  exit 1
                  fi
                }
                # Verify that bash -c doesn't start saving the cache (verify unset BASH_ENV)
                bash -c "echo hi" | assert_not_contains "Saving"
